#!/usr/bin/env fish

# Script: ts-phx
# Version: 1.0.0
# Description: Launch Phoenix server with Tailscale serve in a tmux TUI
# Installation: Copy to ~/bin/scripts

set VERSION "1.0.0"
set SCRIPT_NAME (basename (status filename))
set SESSION_NAME "ts-phx"
set TEMP_DIR "/tmp/$SCRIPT_NAME-$fish_pid"
set STATE_FILE "$TEMP_DIR/state"

function log_info
    logger -t "$SCRIPT_NAME[$fish_pid]" -p user.info $argv
end

function log_error
    logger -t "$SCRIPT_NAME[$fish_pid]" -p user.error $argv
end

function log_debug
    logger -t "$SCRIPT_NAME[$fish_pid]" -p user.debug $argv
end

function show_version
    echo "$SCRIPT_NAME version $VERSION"
    exit 0
end

function run_tests
    log_info "action=test status=starting"
    echo "Running unit tests..."

    # Test port detection
    echo "Testing port detection..."
    set test_port (find_unused_port)
    if test -n "$test_port" -a "$test_port" -gt 1024
        echo "✓ Port detection works: $test_port"
    else
        echo "✗ Port detection failed"
        exit 1
    end

    # Test dependency checks
    echo "Testing dependency checks..."
    for cmd in mix tailscale tmux curl
        if not command -v $cmd >/dev/null 2>&1
            echo "✗ Missing dependency: $cmd"
            exit 1
        end
    end
    echo "✓ All dependencies present"

    echo "All tests passed!"
    log_info "action=test status=complete"
    exit 0
end

function install_fish_completions
    set -l completions_file ~/.config/fish/completions/$SCRIPT_NAME.fish

    if test -f "$completions_file"
        echo "Error: Completions file already exists: $completions_file" >&2
        echo "Remove it first if you want to regenerate completions." >&2
        exit 1
    end

    mkdir -p ~/.config/fish/completions

    echo "# Fish completions for $SCRIPT_NAME
# Generated by $SCRIPT_NAME --fish-completions

complete -c $SCRIPT_NAME -s h -l help -d 'Show help message'
complete -c $SCRIPT_NAME -s v -l version -d 'Show version information'
complete -c $SCRIPT_NAME -l test -d 'Run unit and regression tests'
complete -c $SCRIPT_NAME -l fish-completions -d 'Install fish shell completions'
" > "$completions_file"

    and begin
        echo "Fish completions installed to: $completions_file"
        echo ""
        echo "Completions will be available in new fish shell sessions."
        echo "To use them immediately in this session, run:"
        echo "  source $completions_file"
    end
    or begin
        echo "Error: Failed to write completions file" >&2
        exit 1
    end

    exit 0
end

function usage
    echo "Usage: $SCRIPT_NAME [options]"
    echo ""
    echo "Description: Launch Phoenix server with Tailscale serve in a tmux TUI"
    echo ""
    echo "Features:"
    echo "  - Automatically finds an unused port > 1024"
    echo "  - Starts Phoenix server on that port"
    echo "  - Exposes server via Tailscale serve (auto-detect HTTPS/HTTP)"
    echo "  - Provides interactive tmux TUI with status and logs"
    echo "  - Press '/' for command menu overlay"
    echo ""
    echo "Options:"
    echo "  -h, --help            Show this help message"
    echo "  -v, --version         Show version information"
    echo "  --test                Run unit and regression tests"
    echo "  --fish-completions    Install fish shell completions"
    exit 0
end

function find_unused_port
    # Find an unused TCP port > 1024
    set -l port
    for i in (seq 1 100)
        set port (shuf -i 1025-65535 -n 1 2>/dev/null; or jot -r 1 1025 65535)
        if not nc -z localhost $port 2>/dev/null
            echo $port
            return 0
        end
    end
    log_error "action=find_port status=failed error=\"no available ports found\""
    return 1
end

function check_dependencies
    set -l missing_deps

    for cmd in mix tailscale tmux curl nc
        if not command -v $cmd >/dev/null 2>&1
            set -a missing_deps $cmd
        end
    end

    if test (count $missing_deps) -gt 0
        log_error "action=check_deps status=failed missing=\"$missing_deps\""
        echo "Error: Missing required dependencies: $missing_deps" >&2
        echo "" >&2
        echo "Please install:" >&2
        for dep in $missing_deps
            echo "  - $dep" >&2
        end
        return 1
    end

    return 0
end

function cleanup
    log_info "action=cleanup status=starting"

    # Kill processes if state file exists
    if test -f "$STATE_FILE"
        set -l phoenix_pid (grep "^phoenix_pid=" "$STATE_FILE" | cut -d= -f2)
        set -l tailscale_pid (grep "^tailscale_pid=" "$STATE_FILE" | cut -d= -f2)

        if test -n "$phoenix_pid"
            kill $phoenix_pid 2>/dev/null
            log_debug "action=cleanup target=phoenix pid=$phoenix_pid"
        end

        if test -n "$tailscale_pid"
            kill $tailscale_pid 2>/dev/null
            log_debug "action=cleanup target=tailscale pid=$tailscale_pid"
        end
    end

    # Stop tailscale serve
    tailscale serve reset 2>/dev/null

    # Kill tmux session
    tmux kill-session -t $SESSION_NAME 2>/dev/null

    # Clean up temp files
    rm -rf "$TEMP_DIR"

    log_info "action=cleanup status=complete"
end

function save_state
    set -l key $argv[1]
    set -l value $argv[2]

    mkdir -p "$TEMP_DIR"

    # Update or append the key-value pair
    if test -f "$STATE_FILE"
        grep -v "^$key=" "$STATE_FILE" > "$STATE_FILE.tmp"
        mv "$STATE_FILE.tmp" "$STATE_FILE"
    end

    echo "$key=$value" >> "$STATE_FILE"
end

function get_state
    set -l key $argv[1]

    if test -f "$STATE_FILE"
        grep "^$key=" "$STATE_FILE" | cut -d= -f2
    end
end

function start_phoenix
    set -l port $argv[1]

    log_info "action=start_phoenix port=$port"

    # Start Phoenix in background
    env PORT=$port mix phx.server > "$TEMP_DIR/phoenix.log" 2>&1 &
    set -l phoenix_pid $last_pid

    save_state phoenix_pid $phoenix_pid
    save_state port $port

    echo $phoenix_pid
end

function start_tailscale_serve
    set -l port $argv[1]

    log_info "action=start_tailscale port=$port"

    # Try HTTPS first, fall back to HTTP
    set -l protocol "https"
    tailscale serve https / http://localhost:$port > "$TEMP_DIR/tailscale.log" 2>&1 &
    set -l tailscale_pid $last_pid

    # Wait a moment and check if it's still running
    sleep 2
    if not kill -0 $tailscale_pid 2>/dev/null
        log_info "action=start_tailscale protocol=https status=failed fallback=http"
        # HTTPS failed, try HTTP
        set protocol "http"
        tailscale serve http / http://localhost:$port > "$TEMP_DIR/tailscale.log" 2>&1 &
        set tailscale_pid $last_pid
        sleep 1
    end

    save_state tailscale_pid $tailscale_pid
    save_state protocol $protocol

    echo $tailscale_pid
end

function get_tailscale_url
    # Get the Tailscale URL
    set -l status_output (tailscale serve status 2>/dev/null)

    if test -z "$status_output"
        echo "No URL yet"
        return
    end

    # Extract URL from status output
    set -l url (echo "$status_output" | grep -o 'https://[^[:space:]]*' | head -1)
    if test -z "$url"
        set url (echo "$status_output" | grep -o 'http://[^[:space:]]*' | head -1)
    end

    if test -n "$url"
        echo $url
    else
        echo "Unknown"
    end
end

function verify_tailscale
    set -l url $argv[1]

    log_info "action=verify_tailscale url=$url"

    # Try to curl the URL
    if curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$url" >/dev/null 2>&1
        log_info "action=verify_tailscale status=success"
        return 0
    else
        log_error "action=verify_tailscale status=failed"
        return 1
    end
end

function create_command_menu_pane
    # Create the bottom command menu pane
    set -l menu_content "
╔══════════════════════════════════════════════════════════════════════════════╗
║                            COMMAND MENU                                      ║
║                                                                              ║
║  Press '/' to open command overlay with detailed help                       ║
║                                                                              ║
║  Quick Commands:                                                            ║
║    q - Stop all and exit          r - Restart Phoenix                       ║
║    t - Toggle Tailscale serve     p - List Tailscale peers                  ║
║    h - Show help overlay                                                    ║
╚══════════════════════════════════════════════════════════════════════════════╝
"
    echo "$menu_content"
end

function create_help_overlay
    echo "╔══════════════════════════════════════════════════════════════════════════════╗
║                      PHOENIX + TAILSCALE SERVE - COMMANDS                    ║
╠══════════════════════════════════════════════════════════════════════════════╣
║                                                                              ║
║  PROCESS CONTROL:                                                           ║
║                                                                              ║
║    q - Stop All and Exit                                                    ║
║        Stops both Phoenix and Tailscale serve, then exits the TUI           ║
║                                                                              ║
║    s - Stop Tailscale Serve                                                 ║
║        Stops only the Tailscale serve process (Phoenix keeps running)       ║
║                                                                              ║
║    r - Restart Phoenix                                                      ║
║        Kills and restarts the Phoenix server on the same port               ║
║                                                                              ║
║    t - Restart Tailscale Serve                                              ║
║        Restarts the Tailscale serve process (useful if it fails)            ║
║                                                                              ║
║  INFORMATION:                                                               ║
║                                                                              ║
║    p - List Tailscale Peers                                                 ║
║        Shows all peers currently connected to your Tailnet                  ║
║                                                                              ║
║    h - Show This Help                                                       ║
║        Display this command reference overlay                               ║
║                                                                              ║
║  NAVIGATION:                                                                ║
║                                                                              ║
║    / - Open Command Menu                                                    ║
║        Press '/' at any time to see this help overlay                       ║
║                                                                              ║
║    Esc or Enter - Close Overlay                                             ║
║        Close this help window and return to the log view                    ║
║                                                                              ║
║    Ctrl+B [ - Scroll Mode                                                   ║
║        Enter tmux copy mode to scroll through Phoenix logs                  ║
║        (Use arrow keys, Page Up/Down, then 'q' to exit)                     ║
║                                                                              ║
╠══════════════════════════════════════════════════════════════════════════════╣
║  Press any key to close this overlay                                        ║
╚══════════════════════════════════════════════════════════════════════════════╝" > "$TEMP_DIR/help.txt"
end

function setup_tmux_keybindings
    set -l session $argv[1]

    # Create help overlay content
    create_help_overlay

    # Bind '/' to show help overlay
    tmux bind-key -n '/' display-popup -E -w 80% -h 80% "cat $TEMP_DIR/help.txt; read -n 1"

    # Bind 'q' to stop all and exit
    tmux bind-key -n 'q' run-shell "fish -c 'fish ~/bin/scripts/$SCRIPT_NAME --internal-stop-all'"

    # Bind 's' to stop tailscale serve
    tmux bind-key -n 's' run-shell "fish -c 'fish ~/bin/scripts/$SCRIPT_NAME --internal-stop-tailscale'"

    # Bind 'r' to restart Phoenix
    tmux bind-key -n 'r' run-shell "fish -c 'fish ~/bin/scripts/$SCRIPT_NAME --internal-restart-phoenix'"

    # Bind 't' to restart Tailscale
    tmux bind-key -n 't' run-shell "fish -c 'fish ~/bin/scripts/$SCRIPT_NAME --internal-restart-tailscale'"

    # Bind 'p' to list peers
    tmux bind-key -n 'p' display-popup -E "tailscale status; echo ''; echo 'Press any key to close...'; read -n 1"

    # Bind 'h' to show help
    tmux bind-key -n 'h' display-popup -E -w 80% -h 80% "cat $TEMP_DIR/help.txt; read -n 1"
end

function internal_stop_all
    set -l phoenix_pid (get_state phoenix_pid)
    set -l tailscale_pid (get_state tailscale_pid)

    if test -n "$phoenix_pid"
        kill $phoenix_pid 2>/dev/null
    end

    if test -n "$tailscale_pid"
        kill $tailscale_pid 2>/dev/null
    end

    tailscale serve reset 2>/dev/null
    tmux kill-session -t $SESSION_NAME 2>/dev/null

    log_info "action=stop_all status=complete"
end

function internal_stop_tailscale
    set -l tailscale_pid (get_state tailscale_pid)

    if test -n "$tailscale_pid"
        kill $tailscale_pid 2>/dev/null
    end

    tailscale serve reset 2>/dev/null

    tmux display-message "Tailscale serve stopped"
    log_info "action=stop_tailscale status=complete"
end

function internal_restart_phoenix
    set -l phoenix_pid (get_state phoenix_pid)
    set -l port (get_state port)

    if test -n "$phoenix_pid"
        kill $phoenix_pid 2>/dev/null
        sleep 1
    end

    set -l new_pid (start_phoenix $port)

    tmux display-message "Phoenix restarted (PID: $new_pid)"
    log_info "action=restart_phoenix status=complete pid=$new_pid"
end

function internal_restart_tailscale
    set -l tailscale_pid (get_state tailscale_pid)
    set -l port (get_state port)

    if test -n "$tailscale_pid"
        kill $tailscale_pid 2>/dev/null
    end

    tailscale serve reset 2>/dev/null
    sleep 1

    set -l new_pid (start_tailscale_serve $port)

    tmux display-message "Tailscale serve restarted (PID: $new_pid)"
    log_info "action=restart_tailscale status=complete pid=$new_pid"
end

function update_status_bar
    set -l port (get_state port)
    set -l url (get_tailscale_url)
    set -l phoenix_pid (get_state phoenix_pid)
    set -l tailscale_pid (get_state tailscale_pid)

    # Check if processes are running
    set -l phoenix_status "✗"
    set -l tailscale_status "✗"

    if test -n "$phoenix_pid"; and kill -0 $phoenix_pid 2>/dev/null
        set phoenix_status "✓"
    end

    if test -n "$tailscale_pid"; and kill -0 $tailscale_pid 2>/dev/null
        set tailscale_status "✓"
    end

    set -l status_text "Phoenix:$phoenix_status Port:$port | Tailscale:$tailscale_status URL:$url | Press '/' for commands"

    tmux set-option -t $SESSION_NAME status-right "$status_text"
end

function main
    log_info "action=start status=processing"

    # Check dependencies
    if not check_dependencies
        exit 1
    end

    # Set up cleanup trap
    trap cleanup EXIT INT TERM

    # Create temp directory
    mkdir -p "$TEMP_DIR"

    # Find unused port
    echo "Finding unused port..."
    set -l port (find_unused_port)
    if test -z "$port"
        echo "Error: Could not find an unused port" >&2
        exit 1
    end
    echo "Using port: $port"

    # Start Phoenix server
    echo "Starting Phoenix server on port $port..."
    set -l phoenix_pid (start_phoenix $port)
    echo "Phoenix started (PID: $phoenix_pid)"

    # Wait for Phoenix to start
    echo "Waiting for Phoenix to initialize..."
    sleep 5

    # Start Tailscale serve
    echo "Starting Tailscale serve..."
    set -l tailscale_pid (start_tailscale_serve $port)
    echo "Tailscale serve started (PID: $tailscale_pid)"

    # Wait for Tailscale to start
    echo "Waiting for Tailscale to initialize..."
    sleep 3

    # Get Tailscale URL
    set -l url (get_tailscale_url)
    echo "Tailscale URL: $url"

    # Verify Tailscale serve
    if test "$url" != "No URL yet" -a "$url" != "Unknown"
        echo "Verifying Tailscale serve..."
        if verify_tailscale "$url"
            echo "✓ Tailscale serve is working!"
        else
            echo "⚠ Warning: Could not verify Tailscale serve"
        end
    end

    # Create tmux session
    echo "Creating TUI..."

    # Kill existing session if it exists
    tmux kill-session -t $SESSION_NAME 2>/dev/null

    # Create new session with status bar on top
    tmux new-session -d -s $SESSION_NAME -n main

    # Configure status bar
    tmux set-option -t $SESSION_NAME status-position top
    tmux set-option -t $SESSION_NAME status-left ""
    tmux set-option -t $SESSION_NAME status-right-length 150

    # Split window: top 80% for logs, bottom 20% for menu
    tmux split-window -t $SESSION_NAME:main -v -p 20

    # Set up the menu pane (bottom)
    tmux select-pane -t $SESSION_NAME:main.1
    tmux send-keys -t $SESSION_NAME:main.1 "cat $TEMP_DIR/help.txt 2>/dev/null || echo 'Loading...'; fish" C-m

    # Set up the log pane (top) - tail Phoenix logs
    tmux select-pane -t $SESSION_NAME:main.0
    tmux send-keys -t $SESSION_NAME:main.0 "tail -f $TEMP_DIR/phoenix.log" C-m

    # Set up keybindings
    setup_tmux_keybindings $SESSION_NAME

    # Start status bar updater in background
    fish -c "
        while true
            if not tmux has-session -t $SESSION_NAME 2>/dev/null
                break
            end
            fish ~/bin/scripts/$SCRIPT_NAME --internal-update-status
            sleep 2
        end
    " &

    # Update status bar once
    update_status_bar

    log_info "action=start status=complete port=$port url=$url"

    # Attach to tmux session
    echo ""
    echo "Attaching to TUI... (Press Ctrl+B, then D to detach)"
    sleep 1

    tmux attach-session -t $SESSION_NAME

    # Clean up when tmux exits
    cleanup
end

# Parse arguments
argparse 'h/help' 'v/version' 'test' 'fish-completions' \
    'internal-stop-all' 'internal-stop-tailscale' \
    'internal-restart-phoenix' 'internal-restart-tailscale' \
    'internal-update-status' -- $argv
or begin
    usage
end

if set -q _flag_help
    usage
end

if set -q _flag_version
    show_version
end

if set -q _flag_test
    run_tests
end

if set -q _flag_fish_completions
    install_fish_completions
end

# Internal commands for tmux keybindings
if set -q _flag_internal_stop_all
    internal_stop_all
    exit 0
end

if set -q _flag_internal_stop_tailscale
    internal_stop_tailscale
    exit 0
end

if set -q _flag_internal_restart_phoenix
    internal_restart_phoenix
    exit 0
end

if set -q _flag_internal_restart_tailscale
    internal_restart_tailscale
    exit 0
end

if set -q _flag_internal_update_status
    update_status_bar
    exit 0
end

log_debug "action=init args=\"$argv\""
main
