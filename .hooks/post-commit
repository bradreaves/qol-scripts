#!/usr/bin/env fish

# Post-commit hook: Copy scripts to fish functions and reinstall completions when committing to main

set current_branch (git branch --show-current)

if test "$current_branch" = "main"
    echo "Installing fish functions..."

    # Ensure directories exist
    mkdir -p ~/.config/fish/functions
    mkdir -p ~/.config/fish/completions

    # Get list of changed files in the last commit
    set changed_files (git diff-tree --no-commit-id --name-only -r HEAD)

    # Copy scripts to fish functions and reinstall completions if they changed
    for script in worktree mkcd
        if test -f $script
            # Copy to functions
            cp $script ~/.config/fish/functions/$script.fish
            and echo "  ✓ Installed $script.fish"
            or echo "  ✗ Failed to install $script.fish"

            # Reinstall completions if the script was modified
            if contains $script $changed_files
                # Remove old completions
                set completions_file ~/.config/fish/completions/$script.fish
                if test -f "$completions_file"
                    rm "$completions_file"
                end

                # Install new completions
                fish $script --fish-completions >/dev/null 2>&1
                and echo "  ✓ Reinstalled completions for $script"
                or echo "  ℹ No completions for $script"
            end
        end
    end
end
